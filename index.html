<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>æ‹‰éœ¸æ©Ÿ</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ°</text></svg>" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; touch-action: pan-y; }

    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
      max-width: 500px;
      width: 100%;
      position: relative;
    }

    h1 {
      color: #333;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .slot-machine {
      background: linear-gradient(145deg, #ff6b6b, #ee5a6f);
      border-radius: 15px;
      padding: 30px;
      margin: 30px 0;
      box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.2),
                  0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .slot-window {
      background: #fff;
      border: 8px solid #333;
      border-radius: 10px;
      height: 200px;
      margin: 20px auto;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
    }

    .slot-content {
      position: absolute;
      width: 100%;
      top: 0;
      left: 0;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .slot-content.rolling {
      opacity: 1;
      animation: roll 0.15s infinite linear;
    }

    @keyframes roll {
      0% { transform: translateY(0); }
      100% { transform: translateY(-200px); }
    }

    .options {
      position: absolute;
      width: 100%;
      top: 0;
      left: 0;
      z-index: 1;
    }

    .option-item {
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4em;
      font-weight: bold;
    }

    .result {
      position: absolute;
      width: 100%;
      height: 200px;
      font-size: 4em;
      font-weight: bold;
      color: #fff;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      top: 0;
      left: 0;
      z-index: 2;
      transition: opacity 0.3s;
    }

    .result.hidden { opacity: 0; pointer-events: none; }

    .btn-spin {
      background: linear-gradient(145deg, #4ecdc4, #44a08d);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 1.5em;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      margin-top: 20px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
      width: 100%;
      max-width: 320px;
    }

    .btn-spin:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); }
    .btn-spin:active { transform: scale(0.95) translateY(0); }
    .btn-spin:disabled { background: #ccc; cursor: not-allowed; transform: none; }

    .decorative-line {
      height: 4px;
      background: linear-gradient(90deg, transparent, #333, transparent);
      margin: 15px 0;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn-secondary {
      background: linear-gradient(145deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 1em;
      font-weight: bold;
      border-radius: 25px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); }
    .btn-secondary:active { transform: scale(0.95) translateY(0); }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      animation: fadeIn 0.3s;
    }

    .modal.show {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }

    .modal-content {
      background-color: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 420px;
      width: 92%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s;
      position: relative;
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title { font-size: 1.8em; font-weight: bold; color: #333; }

    .close-btn {
      background: none;
      border: none;
      font-size: 2em;
      cursor: pointer;
      color: #999;
      line-height: 1;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover { color: #333; }

    .modal-body {
      font-size: 1.2em;
      color: #333;
      line-height: 1.6;
    }

    .modal-body .probability-line {
      display: flex;
      justify-content: space-between;
      padding: 12px 14px;
      background: #f5f5f5;
      border-radius: 10px;
      margin-top: 10px;
      font-weight: bold;
    }

    /* Stats */
    .stats-container { text-align: center; }
    .stat-item {
      padding: 20px;
      margin: 15px 0;
      border-radius: 15px;
      font-size: 1.3em;
    }

    .stat-item.weiwei { background: linear-gradient(135deg, #ff6b6b, #ee5a6f); color: #fff; }
    .stat-item.xixi { background: linear-gradient(135deg, #4ecdc4, #44a08d); color: #fff; }

    .stat-count { font-size: 2em; font-weight: bold; margin-top: 10px; }

    /* Probability */
    .password-input {
      width: 100%;
      padding: 15px;
      font-size: 1.2em;
      border: 2px solid #ddd;
      border-radius: 10px;
      margin: 15px 0;
      box-sizing: border-box;
      -webkit-appearance: none;
      appearance: none;
    }

    .password-input:focus { 
      outline: none; 
      border-color: #667eea; 
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .password-error {
      color: #ff6b6b;
      margin-top: 10px;
      display: none;
      font-weight: bold;
    }

    .probability-control { margin: 20px 0; }

    .probability-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 1.1em;
      font-weight: bold;
    }

    .slider {
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: #ddd;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .probability-display {
      margin-top: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 10px;
    }

    .probability-item {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      font-size: 1.1em;
    }

    .save-btn {
      background: linear-gradient(145deg, #4ecdc4, #44a08d);
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 1.1em;
      font-weight: bold;
      border-radius: 25px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 20px;
    }

    .save-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    .save-btn:active { transform: scale(0.95); }

    .hint {
      margin-top: 10px;
      font-size: 0.9em;
      color: #666;
      line-height: 1.4;
    }

    .status-bar {
      margin-top: 10px;
      font-size: 0.9em;
      color: #666;
      opacity: 0.85;
    }

    .cors-warning {
      background: linear-gradient(135deg, #ff9800, #f57c00);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      margin: 20px 0;
      font-size: 0.95em;
      line-height: 1.6;
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
      display: none;
    }

    .cors-warning.show {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .cors-warning strong {
      font-size: 1.1em;
      display: block;
      margin-bottom: 8px;
    }

    .cors-warning code {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
    }

    /* Mobile */
    @media screen and (max-width: 768px) {
      body { padding: 10px; }
      .container { padding: 20px; border-radius: 15px; }
      h1 { font-size: 1.8em; margin-bottom: 20px; }
      .slot-machine { padding: 20px; margin: 20px 0; }
      .slot-window { height: 180px; border-width: 6px; margin: 15px auto; }
      .result { height: 180px; font-size: 3em; }
      .option-item { height: 180px; font-size: 3em; }
      @keyframes roll { 0% { transform: translateY(0); } 100% { transform: translateY(-180px); } }
    }

    @media screen and (max-width: 480px) {
      .container { padding: 15px; }
      h1 { font-size: 1.5em; margin-bottom: 15px; }
      .slot-machine { padding: 15px; margin: 15px 0; }
      .slot-window { height: 160px; border-width: 5px; }
      .result { height: 160px; font-size: 2.5em; }
      .option-item { height: 160px; font-size: 2.5em; }
      @keyframes roll { 0% { transform: translateY(0); } 100% { transform: translateY(-160px); } }
      .modal-content { padding: 20px; }
      .modal-title { font-size: 1.5em; }
    }

    /* Performance */
    .slot-content, .result, .option-item {
      will-change: transform;
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ° æ‹‰éœ¸æ©Ÿ ğŸ°</h1>

    <div class="cors-warning" id="corsWarning">
      <strong>âš ï¸ é‡è¦æç¤ºï¼šè«‹ä½¿ç”¨ HTTP ä¼ºæœå™¨é‹è¡Œæ­¤é é¢</strong>
      æª¢æ¸¬åˆ°æ‚¨æ­£åœ¨ä½¿ç”¨æœ¬åœ°æ–‡ä»¶æ¨¡å¼ (file://)ï¼Œé€™æœƒå°è‡´ CORS éŒ¯èª¤ï¼Œç„¡æ³•é€£æ¥ Google Apps Script APIã€‚<br><br>
      <strong>è§£æ±ºæ–¹æ³•ï¼š</strong><br>
      1. <strong>VS Code:</strong> å®‰è£ "Live Server" æ“´å±•ï¼Œå³éµé»æ“Š index.html â†’ "Open with Live Server"<br>
      2. <strong>Python:</strong> åœ¨æ–‡ä»¶å¤¾ä¸­é‹è¡Œ <code>python -m http.server 8000</code>ï¼Œç„¶å¾Œè¨ªå• <code>http://localhost:8000</code><br>
      3. <strong>Node.js:</strong> å®‰è£ http-server: <code>npx http-server</code>
    </div>

    <div class="slot-machine">
      <div class="slot-window" id="slotWindow">
        <div class="result" id="result">?</div>
        <div class="slot-content" id="slotContent">
          <div class="options" id="options">
            <div class="option-item" style="color:#ff6b6b;">å¨å¨</div>
            <div class="option-item" style="color:#4ecdc4;">èŒœèŒœ</div>
            <div class="option-item" style="color:#ff6b6b;">å¨å¨</div>
            <div class="option-item" style="color:#4ecdc4;">èŒœèŒœ</div>
            <div class="option-item" style="color:#ff6b6b;">å¨å¨</div>
            <div class="option-item" style="color:#4ecdc4;">èŒœèŒœ</div>
            <div class="option-item" style="color:#ff6b6b;">å¨å¨</div>
            <div class="option-item" style="color:#4ecdc4;">èŒœèŒœ</div>
          </div>
        </div>
      </div>
    </div>

    <div class="decorative-line"></div>

    <button class="btn-spin" id="spinBtn" onclick="spin()">é–‹å§‹æŠ½ç</button>

    <div class="btn-group">
      <button class="btn-secondary" onclick="showStats()">ğŸ“Š çµ±è¨ˆ</button>
      <button class="btn-secondary" onclick="showProbabilityModal()">âš™ï¸ èª¿æ•´æ©Ÿç‡</button>
      <button class="btn-secondary" onclick="showCurrentProbability()">ğŸ“ˆ ç›®å‰æ©Ÿç‡</button>
    </div>

    <div class="status-bar" id="statusBar">æ­£åœ¨è¼‰å…¥è¨­å®š...</div>
  </div>

  <!-- Stats Modal -->
  <div id="statsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“Š æŠ½ççµ±è¨ˆ</h2>
        <button class="close-btn" onclick="closeModal('statsModal')">&times;</button>
      </div>

      <div class="stats-container">
        <div class="stat-item weiwei">
          <div>å¨å¨</div>
          <div class="stat-count" id="weiweiCount">0</div>
        </div>

        <div class="stat-item xixi">
          <div>èŒœèŒœ</div>
          <div class="stat-count" id="xixiCount">0</div>
        </div>

        <div style="margin-top: 20px; color: #666;">
          <div>ç¸½è¨ˆ: <strong id="totalCount">0</strong> æ¬¡</div>
        </div>

        <div class="hint">
          âœ… çµ±è¨ˆèˆ‡æ©Ÿç‡ç‚ºå…¨é«”å…±ç”¨ï¼ˆGoogle Sheetï¼‰<br>
          æ¯å€‹äººçœ‹åˆ°çµæœéƒ½ä¸€è‡´
        </div>

        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
          <button class="btn-secondary" onclick="showResetPasswordSection()" style="background: linear-gradient(145deg, #f44336, #d32f2f);">
            ğŸ”„ é‡ç½®çµ±è¨ˆ
          </button>
        </div>

        <div id="resetPasswordSection" style="display: none; margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 10px;">
          <p style="margin-bottom: 10px; font-weight: bold;">è«‹è¼¸å…¥å¯†ç¢¼ä»¥é‡ç½®çµ±è¨ˆï¼š</p>
          <input
            type="password"
            class="password-input"
            id="resetPasswordInput"
            placeholder="è¼¸å…¥å¯†ç¢¼"
            onkeypress="handleResetPasswordKeyPress(event)"
            style="margin-bottom: 10px;"
          />
          <div class="password-error" id="resetPasswordError" style="margin-bottom: 10px;">å¯†ç¢¼éŒ¯èª¤ï¼</div>
          <div style="display: flex; gap: 10px;">
            <button class="save-btn" onclick="resetStats()" style="flex: 1; margin: 0;">ç¢ºèªé‡ç½®</button>
            <button class="btn-secondary" onclick="hideResetPasswordSection()" style="flex: 1; margin: 0; background: #666;">å–æ¶ˆ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Probability Modal -->
  <div id="probabilityModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">âš™ï¸ èª¿æ•´æ©Ÿç‡</h2>
        <button class="close-btn" onclick="closeProbabilityModal()">&times;</button>
      </div>

      <div id="passwordSection">
        <p>è«‹ç™»å…¥ä»¥èª¿æ•´æ©Ÿç‡ï¼š</p>
        <input
          type="text"
          class="password-input"
          id="usernameInput"
          placeholder="å¸³è™Ÿ"
          onkeypress="handleLoginKeyPress(event)"
          style="margin-bottom: 10px;"
        />
        <input
          type="password"
          class="password-input"
          id="passwordInput"
          placeholder="å¯†ç¢¼"
          onkeypress="handleLoginKeyPress(event)"
        />
        <div class="password-error" id="passwordError">å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼</div>
        <button class="save-btn" style="margin-top: 10px;" onclick="checkLogin()">ç™»å…¥</button>
      </div>

      <div id="probabilitySection" style="display:none;">
        <div class="probability-control">
          <div class="probability-label">
            <span>å¨å¨æ©Ÿç‡</span>
            <span id="weiweiPercent">50%</span>
          </div>
          <input
            type="range"
            min="0"
            max="100"
            value="50"
            class="slider"
            id="weiweiSlider"
            oninput="updateProbability('weiwei', this.value)"
          />
        </div>

        <div class="probability-control">
          <div class="probability-label">
            <span>èŒœèŒœæ©Ÿç‡</span>
            <span id="xixiPercent">50%</span>
          </div>
          <input
            type="range"
            min="0"
            max="100"
            value="50"
            class="slider"
            id="xixiSlider"
            oninput="updateProbability('xixi', this.value)"
          />
        </div>

        <div class="probability-display">
          <div class="probability-item">
            <span>å¨å¨:</span>
            <span id="weiweiDisplay">50%</span>
          </div>
          <div class="probability-item">
            <span>èŒœèŒœ:</span>
            <span id="xixiDisplay">50%</span>
          </div>
        </div>

        <button class="save-btn" onclick="saveProbability()">å„²å­˜è¨­å®šï¼ˆåŒæ­¥æ‰€æœ‰äººï¼‰</button>
      </div>
    </div>
  </div>

  <!-- Current Probability Modal -->
  <div id="currentProbabilityModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ“ˆ ç›®å‰æ©Ÿç‡</h2>
        <button class="close-btn" onclick="closeModal('currentProbabilityModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div>ç›®å‰åŒæ­¥åˆ°çš„æ©Ÿç‡å¦‚ä¸‹ï¼š</div>
        <div class="probability-line" id="currentProbabilityLine">å¨å¨ 50% / èŒœèŒœ 50%</div>
      </div>
    </div>
  </div>

  <script>
    // âœ… ä½ çš„ Apps Script URL
    const API_URL =
      "https://script.google.com/macros/s/AKfycbwwESv5cX-FWZqxdT8YaaxrWCGGjgHH7t0t4DEV_QlFUmdXqlaszblLeh1vp9ECbrBcTA/exec";

    // é©—è­‰ API URL
    if (!API_URL || !API_URL.startsWith('https://')) {
      console.error('âš ï¸ API_URL æœªæ­£ç¢ºè¨­ç½®ï¼');
    }

    const options = ["å¨å¨", "èŒœèŒœ"];
    let isSpinning = false;
    let animationTimeout = null;
    let cachedConfig = null;

    // ====== UI Helper ======
    function setStatus(text) {
      const bar = document.getElementById("statusBar");
      if (bar) bar.textContent = text;
    }

    // ====== API ======
    // æª¢æ¸¬æ˜¯å¦åœ¨æœ¬åœ°æ–‡ä»¶æ¨¡å¼ï¼ˆfile://ï¼‰
    function isLocalFile() {
      return window.location.protocol === 'file:' || window.location.protocol === '';
    }

    // JSONP å‚™é¸æ–¹æ¡ˆï¼ˆç¹é CORSï¼‰
    function apiGetJSONP(params) {
      return new Promise((resolve, reject) => {
        // å‰µå»ºå”¯ä¸€çš„å›èª¿å‡½æ•¸å
        const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        let script;
        let timeout;
        
        // è¨­ç½®è¶…æ™‚ï¼ˆ10ç§’ï¼‰
        timeout = setTimeout(() => {
          if (script && document.body.contains(script)) {
            document.body.removeChild(script);
          }
          delete window[callbackName];
          reject(new Error('JSONP è«‹æ±‚è¶…æ™‚'));
        }, 10000);
        
        // å°‡å›èª¿å‡½æ•¸æ·»åŠ åˆ° window å°è±¡
        window[callbackName] = function(data) {
          clearTimeout(timeout);
          // æ¸…ç†
          delete window[callbackName];
          if (script && document.body.contains(script)) {
            document.body.removeChild(script);
          }
          
          if (data && data.ok !== false) {
            resolve(data);
          } else {
            reject(new Error(data?.error || 'JSONP è«‹æ±‚å¤±æ•—'));
          }
        };
        
        // æ§‹å»º URLï¼Œæ·»åŠ  callback åƒæ•¸
        const urlParams = new URLSearchParams(params);
        urlParams.set('callback', callbackName);
        const url = API_URL + "?" + urlParams.toString();
        
        // å‰µå»º script æ¨™ç±¤
        script = document.createElement('script');
        script.src = url;
        script.onerror = () => {
          clearTimeout(timeout);
          delete window[callbackName];
          if (script && document.body.contains(script)) {
            document.body.removeChild(script);
          }
          reject(new Error('JSONP è«‹æ±‚å¤±æ•—ï¼šç„¡æ³•è¼‰å…¥è…³æœ¬'));
        };
        
        // æ·»åŠ åˆ°é é¢è§¸ç™¼è«‹æ±‚
        document.body.appendChild(script);
      });
    }

    async function apiGet(params, useJSONP = false) {
      try {
        // æª¢æŸ¥æ˜¯å¦ç‚ºæœ¬åœ°æ–‡ä»¶æ¨¡å¼
        if (isLocalFile()) {
          console.error('âŒ æª¢æ¸¬åˆ°æœ¬åœ°æ–‡ä»¶æ¨¡å¼ (file://)');
          console.error('âŒ CORS æ”¿ç­–ä¸å…è¨±å¾ file:// ç™¼èµ·è«‹æ±‚');
          return {
            ok: false,
            error: 'è«‹ä½¿ç”¨ HTTP ä¼ºæœå™¨é‹è¡Œæ­¤é é¢ï¼\n\nè§£æ±ºæ–¹æ³•ï¼š\n1. ä½¿ç”¨ VS Code çš„ Live Server æ“´å±•\n2. æˆ–é‹è¡Œ: python -m http.server 8000\nç„¶å¾Œè¨ªå•: http://localhost:8000/index.html'
          };
        }

        // å¦‚æœæŒ‡å®šä½¿ç”¨ JSONP æˆ–ä¹‹å‰ fetch å¤±æ•—éï¼Œä½¿ç”¨ JSONP
        if (useJSONP) {
          console.log('ä½¿ç”¨ JSONP æ–¹å¼è«‹æ±‚ API...');
          return await apiGetJSONP(params);
        }

        // å˜—è©¦ä½¿ç”¨ fetchï¼ˆæ¨™æº–æ–¹å¼ï¼‰
        const url = API_URL + "?" + new URLSearchParams(params).toString();
        
        try {
          const res = await fetch(url, {
            method: 'GET',
            mode: 'cors',
            cache: 'no-cache',
            credentials: 'omit'
          });
          
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          
          const data = await res.json();
          return data;
        } catch (fetchError) {
          // å¦‚æœ fetch å¤±æ•—ï¼ˆé€šå¸¸æ˜¯ CORS å•é¡Œï¼‰ï¼Œè‡ªå‹•å›é€€åˆ° JSONP
          console.warn('Fetch è«‹æ±‚å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ JSONP æ–¹å¼:', fetchError.message);
          return await apiGetJSONP(params);
        }
      } catch (error) {
        console.error("API è«‹æ±‚å¤±æ•—:", error);
        
        // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯
        let errorMsg = error.message || "ç¶²è·¯é€£æ¥å¤±æ•—";
        
        if (error.message.includes('CORS') || error.message.includes('Failed to fetch') || error.message.includes('JSONP')) {
          errorMsg = 'ç„¡æ³•é€£æ¥åˆ° Google Apps Script APIã€‚\n\nğŸ“ Google Apps Script éœ€è¦é…ç½®ï¼š\n1. éƒ¨ç½²ç‚º Web Appï¼ŒåŸ·è¡Œèº«ä»½é¸æ“‡ã€Œä»»ä½•äººã€\n2. åœ¨ doGet å‡½æ•¸ä¸­æ·»åŠ  CORS é ­éƒ¨ï¼Œæˆ–æ”¯æŒ callback åƒæ•¸ï¼ˆJSONPï¼‰\n\nç¯„ä¾‹ä»£ç¢¼ï¼š\nfunction doGet(e) {\n  const callback = e.parameter.callback;\n  const data = { ok: true, ... };\n  \n  if (callback) {\n    // JSONP æ¨¡å¼\n    return ContentService.createTextOutput(callback + "(" + JSON.stringify(data) + ")").setMimeType(ContentService.MimeType.JAVASCRIPT);\n  } else {\n    // æ¨™æº– JSONï¼ˆéœ€è¦ CORSï¼‰\n    return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON).setHeaders({\n      "Access-Control-Allow-Origin": "*"\n    });\n  }\n}';
        }
        
        return { ok: false, error: errorMsg };
      }
    }

    async function loadConfig() {
      try {
        setStatus("æ­£åœ¨åŒæ­¥è¨­å®š...");
        const data = await apiGet({ action: "config" });

        if (!data || !data.ok) {
          const errorMsg = data?.error || "æœªçŸ¥éŒ¯èª¤";
          console.error("è¼‰å…¥è¨­å®šå¤±æ•—:", errorMsg);
          
          // ä½¿ç”¨ç·©å­˜æ•¸æ“šï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
          if (cachedConfig) {
            updateUIFromConfig(cachedConfig);
            setStatus("âš ï¸ ä½¿ç”¨ç·©å­˜æ•¸æ“šï¼ˆç„¡æ³•åŒæ­¥åˆ°ä¼ºæœå™¨ï¼‰");
          } else {
            setStatus("âŒ åŒæ­¥å¤±æ•—ï¼š" + (errorMsg.length > 50 ? errorMsg.substring(0, 50) + "..." : errorMsg));
            // åªåœ¨é¦–æ¬¡å¤±æ•—ä¸”ç„¡ç·©å­˜æ™‚é¡¯ç¤ºè©³ç´°éŒ¯èª¤
            if (errorMsg.includes('CORS') || errorMsg.includes('JSONP') || errorMsg.includes('Google Apps Script')) {
              console.error("è©³ç´°éŒ¯èª¤ä¿¡æ¯:", errorMsg);
              // ä¸å½ˆå‡º alertï¼Œåªåœ¨æ§åˆ¶å°é¡¯ç¤ºè©³ç´°ä¿¡æ¯ï¼Œé¿å…æ‰“æ“¾ç”¨æˆ¶
            }
          }
          return;
        }

        // é©—è­‰æ•¸æ“šçµæ§‹
        if (typeof data.weiweiCount !== "number" || typeof data.xixiCount !== "number" || typeof data.weiweiProbability !== "number") {
          throw new Error("API è¿”å›æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º");
        }

        cachedConfig = data;
        updateUIFromConfig(data);
        setStatus(`åŒæ­¥å®Œæˆ âœ…`);
      } catch (error) {
        console.error("loadConfig éŒ¯èª¤:", error);
        setStatus("åŒæ­¥å¤±æ•—ï¼š" + error.message);
        if (!cachedConfig) {
          alert("è¼‰å…¥è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
        }
      }
    }

    function updateUIFromConfig(data) {
      // çµ±è¨ˆ
      document.getElementById("weiweiCount").textContent = data.weiweiCount || 0;
      document.getElementById("xixiCount").textContent = data.xixiCount || 0;
      document.getElementById("totalCount").textContent = (data.weiweiCount || 0) + (data.xixiCount || 0);

      // æ©Ÿç‡ï¼ˆåªåœ¨å½ˆçª—æ‰“é–‹æ™‚æ›´æ–°ï¼‰
      const weiweiSlider = document.getElementById("weiweiSlider");
      const xixiSlider = document.getElementById("xixiSlider");
      if (weiweiSlider && xixiSlider) {
        const prob = data.weiweiProbability || 50;
        weiweiSlider.value = prob;
        xixiSlider.value = 100 - prob;
        updateProbability("weiwei", prob);
      }

      const probDisplay = data.weiweiProbability ?? 50;
      updateCurrentProbabilityDisplay(probDisplay);
    }

    function formatProbabilityText(probability) {
      const weiwei = Math.round(probability);
      const xixi = 100 - weiwei;
      return `å¨å¨ ${weiwei}% / èŒœèŒœ ${xixi}%`;
    }

    function updateCurrentProbabilityDisplay(probability) {
      const text = formatProbabilityText(probability);
      const modalLine = document.getElementById("currentProbabilityLine");
      if (modalLine) {
        modalLine.textContent = text;
      }
    }

    async function showCurrentProbability() {
      try {
        if (!cachedConfig) await loadConfig();
        const prob = cachedConfig?.weiweiProbability ?? 50;
        updateCurrentProbabilityDisplay(prob);

        const modal = document.getElementById("currentProbabilityModal");
        modal.classList.add("show");
        modal.onclick = (e) => { if (e.target === modal) closeModal("currentProbabilityModal"); };
      } catch (error) {
        console.error("é¡¯ç¤ºç›®å‰æ©Ÿç‡å¤±æ•—:", error);
        setStatus("é¡¯ç¤ºæ©Ÿç‡å¤±æ•—ï¼š" + error.message);
      }
    }

    async function getProbability() {
      try {
        if (!cachedConfig) await loadConfig();
        const p = cachedConfig?.weiweiProbability ?? 50; // é»˜èª50%
        return { weiwei: p / 100, xixi: 1 - p / 100 };
      } catch (error) {
        console.error("getProbability éŒ¯èª¤:", error);
        // è¿”å›é»˜èªå€¼
        return { weiwei: 0.5, xixi: 0.5 };
      }
    }

    async function updateStats(result) {
      try {
        // å˜—è©¦æ›´æ–°çµ±è¨ˆï¼Œåƒæ•¸æ ¼å¼å¯èƒ½éœ€è¦æ ¹æ“šå¾Œç«¯èª¿æ•´
        const data = await apiGet({ 
          action: "spin", 
          result: result 
        });

        if (!data || !data.ok) {
          const errorMsg = data?.error || "æœªçŸ¥éŒ¯èª¤";
          console.error("æ›´æ–°çµ±è¨ˆå¤±æ•—:", errorMsg);
          
          // å¦‚æœå¾Œç«¯è¿”å› "Unknown GET action"ï¼Œæä¾›å¹«åŠ©ä¿¡æ¯
          if (errorMsg.includes("Unknown") || errorMsg.includes("action")) {
            console.warn("âš ï¸ å¾Œç«¯å¯èƒ½ä¸æ”¯æŒ 'spin' actionï¼Œè«‹æª¢æŸ¥ Google Apps Script ä»£ç¢¼");
            console.warn("âš ï¸ å¾Œç«¯æ‡‰è©²è™•ç† action='spin' ä¸¦æ›´æ–°çµ±è¨ˆæ•¸æ“š");
            setStatus("âš ï¸ çµ±è¨ˆæ›´æ–°å¤±æ•—ï¼ˆå¾Œç«¯é…ç½®å•é¡Œï¼‰");
          } else {
            setStatus("çµ±è¨ˆæ›´æ–°å¤±æ•—ï¼š" + errorMsg);
          }
          
          // ä¸é¡¯ç¤ºå½ˆçª—ï¼Œåªåœ¨ç‹€æ…‹æ¬„æç¤ºï¼ˆä¸å½±éŸ¿ç”¨æˆ¶é«”é©—ï¼‰
          return;
        }
        
        // æˆåŠŸå¾Œé‡æ–°è¼‰å…¥é…ç½®
        await loadConfig();
      } catch (error) {
        console.error("updateStats éŒ¯èª¤:", error);
        setStatus("çµ±è¨ˆæ›´æ–°å¤±æ•—ï¼š" + error.message);
      }
    }

    async function saveProbability() {
      try {
        const weiweiProb = parseInt(document.getElementById("weiweiSlider").value);

        if (isNaN(weiweiProb) || weiweiProb < 0 || weiweiProb > 100) {
          alert("æ©Ÿç‡å¿…é ˆåœ¨ 0-100 ä¹‹é–“");
          return;
        }

        setStatus("æ­£åœ¨å„²å­˜æ©Ÿç‡è¨­å®š...");
        // å¾Œç«¯é©—è­‰ä½¿ç”¨ daven å¯†ç¢¼
        const data = await apiGet({
          action: "probability",
          weiweiProbability: weiweiProb,
          password: "daven",
          updatedBy: "web-user"
        });

        if (!data || !data.ok) {
          document.getElementById("passwordError").style.display = "block";
          const errorMsg = data?.error || "æœªçŸ¥éŒ¯èª¤";
          console.error("å„²å­˜æ©Ÿç‡å¤±æ•—:", errorMsg);
          alert("æ›´æ–°å¤±æ•—ï¼š" + errorMsg);
          setStatus("å„²å­˜å¤±æ•—");
          return;
        }

        alert("æ©Ÿç‡è¨­å®šå·²å„²å­˜ä¸¦åŒæ­¥çµ¦æ‰€æœ‰äººï¼");
        closeProbabilityModal();
        await loadConfig();
      } catch (error) {
        console.error("saveProbability éŒ¯èª¤:", error);
        document.getElementById("passwordError").style.display = "block";
        alert("å„²å­˜è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
        setStatus("å„²å­˜å¤±æ•—");
      }
    }

    // ====== Slot Machine ======
    async function spin() {
      if (isSpinning) return;
      
      try {
        isSpinning = true;

        const spinBtn = document.getElementById("spinBtn");
        const slotContent = document.getElementById("slotContent");
        const resultDiv = document.getElementById("result");

        if (animationTimeout) clearTimeout(animationTimeout);

        document.body.style.overflow = "hidden";
        spinBtn.disabled = true;
        spinBtn.textContent = "æŠ½çä¸­...";

        resultDiv.classList.add("hidden");
        slotContent.style.opacity = "";
        slotContent.classList.add("rolling");

        const prob = await getProbability();
        const randomResult = Math.random() < prob.weiwei ? options[0] : options[1];

        const spinDuration = 2000 + Math.random() * 1000;

        animationTimeout = setTimeout(async () => {
          try {
            slotContent.classList.remove("rolling");

            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                slotContent.style.opacity = "0";

                setTimeout(async () => {
                  try {
                    resultDiv.textContent = randomResult;
                    resultDiv.style.color = randomResult === "å¨å¨" ? "#ff6b6b" : "#4ecdc4";
                    resultDiv.classList.remove("hidden");

                    // éé˜»å¡å¼æ›´æ–°çµ±è¨ˆï¼ˆå³ä½¿å¤±æ•—ä¹Ÿä¸å½±éŸ¿é¡¯ç¤ºçµæœï¼‰
                    updateStats(randomResult).catch(err => {
                      console.error("æ›´æ–°çµ±è¨ˆå¤±æ•—ï¼ˆéé˜»å¡ï¼‰:", err);
                    });

                    resultDiv.style.animation = "none";
                    setTimeout(() => {
                      resultDiv.style.animation = "bounce 0.5s ease";
                    }, 10);

                    document.body.style.overflow = "";
                    isSpinning = false;
                    spinBtn.disabled = false;
                    spinBtn.textContent = "å†ç©ä¸€æ¬¡";
                  } catch (error) {
                    console.error("é¡¯ç¤ºçµæœæ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                    // ç¢ºä¿æ¢å¾©ç‹€æ…‹
                    document.body.style.overflow = "";
                    isSpinning = false;
                    spinBtn.disabled = false;
                    spinBtn.textContent = "é–‹å§‹æŠ½ç";
                    alert("é¡¯ç¤ºçµæœæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
                  }
                }, 200);
              });
            });
          } catch (error) {
            console.error("å‹•ç•«åœæ­¢æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
            // æ¢å¾©ç‹€æ…‹
            slotContent.classList.remove("rolling");
            document.body.style.overflow = "";
            isSpinning = false;
            spinBtn.disabled = false;
            spinBtn.textContent = "é–‹å§‹æŠ½ç";
          }
        }, spinDuration);
      } catch (error) {
        console.error("spin å‡½æ•¸éŒ¯èª¤:", error);
        // æ¢å¾©ç‹€æ…‹
        document.body.style.overflow = "";
        isSpinning = false;
        const spinBtn = document.getElementById("spinBtn");
        if (spinBtn) {
          spinBtn.disabled = false;
          spinBtn.textContent = "é–‹å§‹æŠ½ç";
        }
        alert("æŠ½çæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
      }
    }

    // ====== Modals ======
    async function showStats() {
      const modal = document.getElementById("statsModal");
      modal.classList.add("show");
      modal.onclick = (e) => { if (e.target === modal) closeModal("statsModal"); };
      // éé˜»å¡å¼è¼‰å…¥çµ±è¨ˆ
      loadConfig().catch(err => {
        console.error("è¼‰å…¥çµ±è¨ˆå¤±æ•—:", err);
      });
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove("show");
      // å…³é—­æ—¶éšè—é‡ç½®å¯†ç åŒºåŸŸ
      if (id === 'statsModal') {
        hideResetPasswordSection();
      }
    }

    // ====== é‡ç½®çµ±è¨ˆç›¸é—œå‡½æ•¸ ======
    function showResetPasswordSection() {
      document.getElementById("resetPasswordSection").style.display = "block";
      document.getElementById("resetPasswordInput").value = "";
      document.getElementById("resetPasswordError").style.display = "none";
      setTimeout(() => {
        document.getElementById("resetPasswordInput").focus();
      }, 100);
    }

    function hideResetPasswordSection() {
      document.getElementById("resetPasswordSection").style.display = "none";
      document.getElementById("resetPasswordInput").value = "";
      document.getElementById("resetPasswordError").style.display = "none";
    }

    function handleResetPasswordKeyPress(e) {
      if (e.key === "Enter") {
        resetStats();
      }
    }

    async function resetStats() {
      const password = document.getElementById("resetPasswordInput").value.trim();
      const errorDiv = document.getElementById("resetPasswordError");
      
      if (!password) {
        errorDiv.style.display = "block";
        errorDiv.textContent = "è«‹è¼¸å…¥å¯†ç¢¼ï¼";
        return;
      }
      
      // é©—è­‰å¯†ç¢¼
      if (password !== 'carol') {
        errorDiv.style.display = "block";
        errorDiv.textContent = "å¯†ç¢¼éŒ¯èª¤ï¼";
        document.getElementById("resetPasswordInput").value = "";
        return;
      }
      
      // å¯†ç¢¼æ­£ç¢ºï¼Œé‡ç½®çµ±è¨ˆ
      try {
        setStatus("æ­£åœ¨é‡ç½®çµ±è¨ˆ...");
        errorDiv.style.display = "none";
        
        // èª¿ç”¨ API é‡ç½®çµ±è¨ˆ
        const data = await apiGet({
          action: "reset",
          password: password
        });
        
        if (!data || !data.ok) {
          const errorMsg = data?.error || "æœªçŸ¥éŒ¯èª¤";
          errorDiv.style.display = "block";
          errorDiv.textContent = "é‡ç½®å¤±æ•—ï¼š" + errorMsg;
          console.error("é‡ç½®çµ±è¨ˆå¤±æ•—:", errorMsg);
          return;
        }
        
        // é‡ç½®æˆåŠŸ
        alert("çµ±è¨ˆå·²é‡ç½®ï¼");
        hideResetPasswordSection();
        
        // é‡æ–°è¼‰å…¥é…ç½®ä»¥æ›´æ–°é¡¯ç¤º
        await loadConfig();
        setStatus("çµ±è¨ˆå·²é‡ç½® âœ…");
        
      } catch (error) {
        console.error("é‡ç½®çµ±è¨ˆéŒ¯èª¤:", error);
        errorDiv.style.display = "block";
        errorDiv.textContent = "é‡ç½®å¤±æ•—ï¼š" + error.message;
        setStatus("é‡ç½®å¤±æ•—");
      }
    }

    function showProbabilityModal() {
      const modal = document.getElementById("probabilityModal");

      document.getElementById("passwordSection").style.display = "block";
      document.getElementById("probabilitySection").style.display = "none";
      document.getElementById("usernameInput").value = "";
      document.getElementById("passwordInput").value = "";
      document.getElementById("passwordError").style.display = "none";

      modal.classList.add("show");
      modal.onclick = (e) => { if (e.target === modal) closeProbabilityModal(); };
      
      // è‡ªå‹•èšç„¦åˆ°å¸³è™Ÿè¼¸å…¥æ¡†
      setTimeout(() => {
        document.getElementById("usernameInput").focus();
      }, 100);
    }

    function closeProbabilityModal() {
      closeModal("probabilityModal");
    }

    function handleLoginKeyPress(e) {
      if (e.key === "Enter") checkLogin();
    }

    async function checkLogin() {
      const username = document.getElementById("usernameInput").value.trim();
      const password = document.getElementById("passwordInput").value.trim();
      const errorDiv = document.getElementById("passwordError");
      
      if (!username || !password) {
        errorDiv.style.display = "block";
        errorDiv.textContent = "è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼ï¼";
        return;
      }
      
      // é©—è­‰å¸³è™Ÿå’Œå¯†ç¢¼
      if (username === 'superadmin' && password === '123456') {
        // ç™»å…¥æˆåŠŸ
        errorDiv.style.display = "none";
        document.getElementById("passwordSection").style.display = "none";
        document.getElementById("probabilitySection").style.display = "block";
        // è¼‰å…¥è¨­å®š
        loadConfig().catch(err => {
          console.error("è¼‰å…¥è¨­å®šå¤±æ•—:", err);
        });
      } else {
        // ç™»å…¥å¤±æ•—
        errorDiv.style.display = "block";
        errorDiv.textContent = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼";
        // æ¸…ç©ºå¯†ç¢¼æ¬„ä½
        document.getElementById("passwordInput").value = "";
      }
    }

    function updateProbability(type, value) {
      const v = parseInt(value);
      const other = 100 - v;

      if (type === "weiwei") {
        document.getElementById("weiweiPercent").textContent = v + "%";
        document.getElementById("weiweiDisplay").textContent = v + "%";
        document.getElementById("xixiSlider").value = other;
        document.getElementById("xixiPercent").textContent = other + "%";
        document.getElementById("xixiDisplay").textContent = other + "%";
      } else {
        document.getElementById("xixiPercent").textContent = v + "%";
        document.getElementById("xixiDisplay").textContent = v + "%";
        document.getElementById("weiweiSlider").value = other;
        document.getElementById("weiweiPercent").textContent = other + "%";
        document.getElementById("weiweiDisplay").textContent = other + "%";
      }
    }

    // Bounce animation
    const style = document.createElement("style");
    style.textContent = `
      @keyframes bounce {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
      }
    `;
    document.head.appendChild(style);

    // Init
    window.onload = () => {
      // æª¢æŸ¥æ˜¯å¦ç‚ºæœ¬åœ°æ–‡ä»¶æ¨¡å¼
      if (isLocalFile()) {
        const warningDiv = document.getElementById("corsWarning");
        if (warningDiv) {
          warningDiv.classList.add("show");
        }
        setStatus("âš ï¸ æœ¬åœ°æ–‡ä»¶æ¨¡å¼ï¼šè«‹ä½¿ç”¨ HTTP ä¼ºæœå™¨é‹è¡Œ");
        console.error("âŒ è«‹ä½¿ç”¨ HTTP ä¼ºæœå™¨é‹è¡Œæ­¤é é¢ï¼Œä¸è¦ç›´æ¥ç”¨ file:// æ‰“é–‹");
        return; // ä¸å˜—è©¦é€£æ¥ API
      }
      
      // æ­£å¸¸æ¨¡å¼ï¼Œå˜—è©¦è¼‰å…¥é…ç½®
      loadConfig().catch(err => {
        console.error("åˆå§‹åŒ–è¼‰å…¥è¨­å®šå¤±æ•—:", err);
        setStatus("åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡æ–°è¼‰å…¥é é¢");
      });
    };
  </script>
</body>
</html>
